import telebot
import requests
import random
from telebot.types import InlineKeyboardMarkup, InlineKeyboardButton, InputMediaPhoto
from concurrent.futures import ThreadPoolExecutor

# APIs
SeedReam = "https://sii3.top/api/SeedReam-4.php"
PromptAPI = "https://sii3.top/api/prompt-img.php?text="

# Token Ø§Ù„Ø¨ÙˆØª
T = telebot.TeleBot("7863334400:AAHCp4jO-pd2qqGQKqxLF1GGHh4w-0zPhqQ")

# ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
user_photos = {}
user_action = {}

# Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø±Ù…ÙˆØ² Ø§Ù„ØªØ¹Ø¨ÙŠØ±ÙŠØ© Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠØ©
emojis = ["â¤ï¸", "ðŸ§¡", "ðŸ’›", "ðŸ’š", "ðŸ©µ", "ðŸ’™", "ðŸ’œ", "ðŸ¤Ž", "ðŸ’“", "ðŸ’—", "ðŸ’–", "ðŸ’", "ðŸ©·", "ðŸ’˜", "ðŸ¤", "ðŸ©¶", "ðŸ–¤", "ðŸ’ž", "ðŸ’•", "â™¥ï¸", "â£ï¸", "â¤ï¸â€ðŸ©¹", "ðŸ’”", "â¤ï¸â€ðŸ”¥", "ðŸ’‹", "ðŸ«€"]

def get_random_emoji():
    """Ø¥Ø±Ø¬Ø§Ø¹ Ø±Ù…Ø² ØªØ¹Ø¨ÙŠØ±ÙŠ Ø¹Ø´ÙˆØ§Ø¦ÙŠ"""
    return random.choice(emojis)

def send_request(t, l=[]):
    """Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø¥Ù„Ù‰ API SeedReam"""
    return requests.post(SeedReam, data={"text": t, "links": ",".join(l)}).json().get("image")

def darkai():
    """ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª"""
    T.polling()

@T.message_handler(commands=['start'])
def start_cmd(m):
    """Ù…Ø¹Ø§Ù„Ø¬ Ø£Ù…Ø± Ø§Ù„Ø¨Ø¯Ø¡"""
    uid = m.from_user.id
    markup = InlineKeyboardMarkup(row_width=1)
    emoji = get_random_emoji()
    markup.add(InlineKeyboardButton(f"Ø®Ø¯Ù…Ø§ØªÙ†Ø§ {emoji}", callback_data="our_services"))
    T.send_message(uid, "Ø£Ù‡Ù„Ø§Ù‹! Ø£Ù†Ø§ SeedReam 4.0 Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ± ðŸ«§", reply_markup=markup)

@T.callback_query_handler(func=lambda c: c.data == "our_services")
def our_services(c):
    """Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª"""
    markup = InlineKeyboardMarkup(row_width=1)
    emoji1 = get_random_emoji()
    emoji2 = get_random_emoji()
    emoji3 = get_random_emoji()
    markup.add(
        InlineKeyboardButton(f"Ø¥Ù†Ø´Ø§Ø¡ ØµÙˆØ±Ø© {emoji1}", callback_data="create_img"),
        InlineKeyboardButton(f"ØªØ¹Ø¯ÙŠÙ„ ØµÙˆØ±Ø© {emoji2}", callback_data="edit_img"),
        InlineKeyboardButton(f"Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø±ÙˆÙ…Ø¨Øª {emoji3}", callback_data="create_prompt")
    )
    try:
        T.edit_message_text("Ø§Ø®ØªØ± Ø§Ù„Ø®Ø¯Ù…Ø© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯Ù‡Ø§:", c.message.chat.id, c.message.message_id, reply_markup=markup)
    except:
        pass

@T.callback_query_handler(func=lambda c: c.data in ["create_img", "edit_img", "create_prompt"])
def action_select(c):
    """Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø¯Ù…Ø©"""
    user_action[c.from_user.id] = c.data
    if c.data == "create_img":
        text = "Ø£Ø±Ø³Ù„ ÙˆØµÙ Ø§Ù„ØµÙˆØ±Ø©"
    elif c.data == "edit_img":
        text = "Ø£Ø±Ø³Ù„ Ø§Ù„ØµÙˆØ±Ø© (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 4)"
    else:  # create_prompt
        text = "Ø£Ø±Ø³Ù„ Ø§Ù„Ù†Øµ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª"
    try:
        T.edit_message_text(text, c.message.chat.id, c.message.message_id)
    except:
        pass
    try:
        T.edit_message_reply_markup(c.message.chat.id, c.message.message_id, reply_markup=None)
    except:
        pass

@T.message_handler(content_types=['photo'])
def handle_photos(m):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù„ØªØ¹Ø¯ÙŠÙ„"""
    uid = m.from_user.id
    if user_action.get(uid) != "edit_img":
        return
    user_photos.setdefault(uid, []).append(m.photo[-1].file_id)
    if len(user_photos[uid]) > 4:
        user_photos[uid] = user_photos[uid][:4]
    if len(user_photos[uid]) == 1:
        T.send_message(uid, "Ø£Ø±Ø³Ù„ ÙˆØµÙ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„")

@T.message_handler(func=lambda m: True)
def handle_description(m):
    """Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù†ØµÙˆØµ Ø§Ù„Ù…Ø±Ø³Ù„Ø©"""
    uid = m.from_user.id
    action = user_action.get(uid)
    
    if action == "edit_img" and uid in user_photos and user_photos[uid]:
        # Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
        wait_st = T.send_sticker(uid, "CAACAgIAAxkBAAIMcmjDndyMvCb2OBQhIGobGVZU4f6JAAK0IwACmEspSN65vs0qW-TZNgQ")
        desc = m.text
        links = [f"https://api.telegram.org/file/bot{T.token}/{T.get_file(fid).file_path}" for fid in user_photos[uid]]
        cap = (desc[:1021] + "...") if len(desc) > 1024 else desc
        
        with ThreadPoolExecutor() as e:
            results = list(e.map(lambda _: send_request(desc, links), range(2)))
        
        media = []
        for i, u in enumerate(results):
            if not u:
                continue
            if i == 0:
                media.append(InputMediaPhoto(media=u, caption=f"<b><blockquote>{cap}</blockquote></b>", parse_mode="HTML", has_spoiler=True))
            else:
                media.append(InputMediaPhoto(media=u, has_spoiler=True))
        
        if media:
            T.send_media_group(uid, media)
        
        try:
            T.delete_message(uid, wait_st.message_id)
        except:
            pass
        
        user_photos[uid] = []
        user_action.pop(uid, None)
        
    elif action == "create_img":
        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©
        wait_st = T.send_sticker(uid, "CAACAgIAAxkBAAIMcmjDndyMvCb2OBQhIGobGVZU4f6JAAK0IwACmEspSN65vs0qW-TZNgQ")
        desc = m.text
        cap = (desc[:1021] + "...") if len(desc) > 1024 else desc
        
        with ThreadPoolExecutor() as e:
            results = list(e.map(lambda _: send_request(desc), range(2)))
        
        media = []
        for i, u in enumerate(results):
            if not u:
                continue
            if i == 0:
                media.append(InputMediaPhoto(media=u, caption=f"<b><blockquote>{cap}</blockquote></b>", parse_mode="HTML", has_spoiler=True))
            else:
                media.append(InputMediaPhoto(media=u, has_spoiler=True))
        
        if media:
            T.send_media_group(uid, media)
        
        try:
            T.delete_message(uid, wait_st.message_id)
        except:
            pass
        
        user_action.pop(uid, None)
        
    elif action == "create_prompt":
        # Ù…Ø¹Ø§Ù„Ø¬Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª
        wait_st = T.send_sticker(uid, "CAACAgIAAxkBAAIMcmjDndyMvCb2OBQhIGobGVZU4f6JAAK0IwACmEspSN65vs0qW-TZNgQ")
        prompt_text = m.text
        
        # Ø§Ø³ØªØ®Ø¯Ø§Ù… API Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ø±ÙˆÙ…Ø¨Øª
        image_url = PromptAPI + requests.utils.quote(prompt_text)
        
        try:
            T.send_photo(uid, image_url, caption=f"<b><blockquote>{prompt_text}</blockquote></b>", parse_mode="HTML")
        except Exception as e:
            T.send_message(uid, f"Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØµÙˆØ±Ø©: {str(e)}")
        
        try:
            T.delete_message(uid, wait_st.message_id)
        except:
            pass
        
        user_action.pop(uid, None)

# ØªØ´ØºÙŠÙ„ Ø§Ù„Ø¨ÙˆØª
if __name__ == "__main__":
    darkai()
